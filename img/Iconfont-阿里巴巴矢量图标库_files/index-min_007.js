KISSY.add("components/album_dialog_edit/index",function(a,b,c,d,e){var f=a.all,g=308,h=1024,i=0,j=["16","20","32","48","52"],k="@TEMPLATE|"+Brix.absoluteFilePath(this,"template.html")+"|TEMPLATE@",l=b.extend({bindUI:function(){var a=this;i=16;var b=this.pagelet.get("data");a.set("iconid",b.iconid),a.set("pid",b.pid),a.getIconInfo(),a.bind()},initGridSelect:function(){var b=this;a.one(".edit_dialog").delegate("change",".edit-size-combobox-input",function(a){var c=f(a.currentTarget);i=parseInt(c.val()),i||(i=16,c.val(i)),b.initGrid()});var c=new e({render:"#J_size_input",dataSource:new e.LocalDataSource({data:j}),width:62,prefixCls:"edit-size-",hasTrigger:!1,maxItemCount:12});c.render(),a.one(".edit-size-combobox-input").val("16"),c.get("input").on("focus",function(){c.sendRequest("")}),c.on("click",function(a){var c=a.target;i=parseInt(c.get("value")),b.initGrid()})},initGrid:function(){for(var a=this,b=i,c=g/b,d=[],e=[],f="",h=0;b>=h;h++){var j=h*c,k=0==h||h==b?" border":"";d.push('<div class="hLine'+k+'" style="top: '+j+'px"></div>'),e.push('<div class="vLine'+k+'" style="left: '+j+'px"></div>')}f+=d.join("")+e.join(""),a.setChunkData("gridhtml",f)},getIconInfo:function(){var b=this,d=b.get("iconid"),e=b.get("pid");a.io({url:"/icons/"+d+"/getSvg",type:"get",data:{pid:e},dataType:"json",success:function(a){a.isok?(b.setChunkData("mode",a.data),!a.data.isRepositorieUser&&b.set("category_id",1),b.initGrid(),b.initGridSelect()):c.alert("sorry!!!something was wrong!!!")}})},bind:function(){},_showInfo:function(a,b){var c=this,b=b||"error",a=a||"",d='<span class="info '+b+'">'+a+"</span>";c.setChunkData({info:d})},_selectToggleNode:function(a){var b=this,c=a.attr("data-index"),d=b.get("paths");d[c]?(a.attr("fill","#f3fcff"),delete d[c]):(a.attr("fill","#FFFCBD"),d[c]=a),b.set("paths",d)},_transFormNodes:function(b){var c=this,e=c.get("paths"),b=arguments[0],f=a.makeArray(arguments).slice(1);a.isEmptyObject(e)?(e=a.all(".svgpath"),a.all(".svgpath").each(function(c){var e=a.one(c).attr("d");d.setPath(e),d[b].apply(d,f),e=d.getPathData(),a.one(c).attr("d",e)})):a.each(e,function(a){var c=a.attr("d");d.setPath(c),d[b].apply(d,f),c=d.getPathData(),a.attr("d",c)})},syncLoad:function(b,d,e){var g=this;a.io({url:b,type:"post",dataType:"json",data:d,headers:{"X-CSRF-Token":f('meta[name="csrf-token"]').attr("content")},success:function(a){a.isok?(c.hideDialog(),e&&e(),location.href=locationUrl):g._showInfo(a.info)}})},_fixSvg:function(a){return d.setPath(a),d.scale(1,-1),d.translate(0,c.icon_ascent),d.getPathData()},_changeSvg:function(a){var b=this,c=h/i/3,d=h/2;switch(a){case"left":b._transFormNodes("translate",-c,0);break;case"right":b._transFormNodes("translate",c,0);break;case"top":b._transFormNodes("translate",0,-c);break;case"bottom":b._transFormNodes("translate",0,c);break;case"scaleDown":b._transFormNodes("translate",-d,-d),b._transFormNodes("scale",1-1/i),b._transFormNodes("translate",d,d);break;case"scaleUp":b._transFormNodes("translate",-d,-d),b._transFormNodes("scale",1/(1-1/i)),b._transFormNodes("translate",d,d);break;case"rotateLeft":b._transFormNodes("translate",-d,-d),b._transFormNodes("rotate",45),b._transFormNodes("translate",d,d);break;case"rotateRight":b._transFormNodes("translate",-d,-d),b._transFormNodes("rotate",-45),b._transFormNodes("translate",d,d)}}},{ATTRS:{tmpl:{value:k},paths:{value:{}}},EVENTS:{path:{click:function(a){var b=this,c=f(a.currentTarget);b._selectToggleNode(c)}},".edit_size_icon":{click:function(b){var c=this,d=f(b.currentTarget),e=d.attr("data-size");i=parseInt(e),a.one("#J_edit_size_input").val(e),c.initGrid()}},".manage_type":{click:function(a){var b=this,c=f(a.currentTarget),d=c.attr("data-control");b._changeSvg(d)}},"#J_edit_size_enable":{click:function(a){var b=(f(a.currentTarget),f(".edit_grid"));b.toggleClass("edit_grid_hide")}},"#J_cancel":{click:function(){c.hideDialog()}},".icon_type_val":{click:function(a){var b=this,c=f(a.currentTarget);b.set("category_id",c.val())}},".finish_copy":{click:function(){var b=this,c=b.get("iconid"),d=b.get("pid"),e=[],f="",g="",h=a.one(".edit_font_class").val();a.all(".svgpath").each(function(a){e.push(a.attr("d"))}),f=e.join("|"),g=b._fixSvg(e.join("")),b._showInfo("正在生成副本，请稍后。。。。","log");var i,j,k;if(d){var l=parseInt(a.one(".edit_unicode").val(),16);i={"phi[unicode]":l,"phi[prototype_svg]":f,"phi[svg]":g,pid:d,"phi[font_class]":h},j="/icons/"+c+"/copyProjectIcon",k="/users/"+userId+"/project?pid="+d}else i={"icon[prototype_svg]":f,"icon[svg]":g,"icon[font_class]":h},j="/icons/"+c+"/copyRepositorieIcon",i["icon[name]"]=a.one(".edit_name").val(),i["icon[slug]"]=a.one(".edit_tags").val(),i["icon[category_id]"]=b.get("category_id")||a.one("input[name='icon_type'][checked]").val(),k="/users/"+userId+"/myuploads";b.syncLoad(j,i,function(){location.href=k})}},".finish_update":{click:function(){var b=this,c=b.get("iconid"),d=b.get("pid"),e=[],f="",g="",h=a.one(".edit_font_class").val();a.all(".svgpath").each(function(a){e.push(a.attr("d"))}),f=e.join("|"),g=b._fixSvg(e.join("")),b._showInfo("正在生成，请稍后。。。。","log");var i,j,k;if(d){var l=parseInt(a.one(".edit_unicode").val(),16);i={"phi[unicode]":l,"phi[prototype_svg]":f,"phi[svg]":g,pid:d,"phi[font_class]":h},j="/icons/"+c+"/updateProjectIcon",k="/users/"+userId+"/project?pid="+d}else i={"icon[prototype_svg]":f,"icon[svg]":g,"icon[font_class]":h},j="/icons/"+c+"/updateRepositorieIcon",i["icon[name]"]=a.one(".edit_name").val(),i["icon[slug]"]=a.one(".edit_tags").val(),i["icon[category_id]"]=b.get("category_id")||a.one("input[name='icon_type'][checked]").val(),k="/users/"+userId+"/myuploads";b.syncLoad(j,i,function(){location.href=k})}}}});return l},{requires:["brix/core/brick","components/custom_helper/","components/gallery_svgpath/index","combobox"]});